<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Registo Apostas com Martingale</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" type="application/manifest+json">

  <!-- Theme color (Android status bar) -->
  <meta name="theme-color" content="#2d7ef7" />

  <!-- PWA Icons -->
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="icons/icon-512.png">

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => console.log("Service Worker registado"))
          .catch(err => console.error("Erro SW:", err));
      });
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #111;
      --bg-card: #1b1b1b;
      --bg-input: #222;
      --border: #444;
      --text: #eee;
      --accent: #2d7ef7;
      --accent-soft: #2d7ef722;
      --success: #2ecc71;
      --danger: #e74c3c;
      --warning: #f1c40f;
    }

    :root[data-theme="light"] {
      --bg: #f2f2f2;
      --bg-card: #ffffff;
      --bg-input: #fafafa;
      --border: #ccc;
      --text: #222;
      --accent: #2563eb;
      --accent-soft: #2563eb18;
      --success: #15803d;
      --danger: #b91c1c;
      --warning: #eab308;
    }

    * { box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
    }

    .page-wrapper {
      max-width: 1100px;
      margin: 0 auto 40px auto;
    }

    h1,h2 { text-align: center; margin: 0 0 10px; }

    .card {
      background: var(--bg-card);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    input,select,button {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      margin-top: 4px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text);
    }

    button.primary { background: var(--accent); border: none; font-weight: bold; cursor: pointer; }
    button.small { width: auto; padding: 4px 8px; font-size: 0.8rem; cursor: pointer; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 750px; }
    th,td { border: 1px solid var(--border); padding: 5px; text-align: center; }
    th { background: var(--accent-soft); }

    .status-ganha   { color: var(--success); font-weight: bold; }
    .status-perdida { color: var(--danger); font-weight: bold; }
    .status-pendente{ color: var(--warning); font-weight: bold; }

    .flex-row { display:flex; gap:10px; flex-wrap:wrap; }
    .flex-item { flex:1 1 200px; }

    .stat-box {
      background: var(--bg-input);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      text-align: center;
      flex:1 1 120px;
    }

    .table-wrapper { width:100%; overflow-x:auto; }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .header-right {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 260px;
      margin-bottom: 20px;
    }

    @media (max-width: 600px) {
      table { min-width: 600px; }
      .chart-container { height: 220px; }
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- HEADER -->
    <div class="header-bar">
      <div class="header-left">
        <h1 data-i18n="title">Registo Apostas Martingale</h1>
      </div>

      <div class="header-right">

        <!-- SeleÃ§Ã£o de idioma -->
        <select id="langSwitcher" style="padding:6px; border-radius:8px;">
          <option value="pt">ðŸ‡µðŸ‡¹ PortuguÃªs</option>
          <option value="en">ðŸ‡¬ðŸ‡§ English</option>
        </select>

        <!-- BotÃ£o de Tema -->
        <button id="themeBtn" class="small">ðŸŒ™ Escuro</button>
      </div>
    </div>


    <!-- CONFIGURAÃ‡ÃƒO -->
    <div class="card">
      <h2 data-i18n="config">ConfiguraÃ§Ã£o</h2>
      <div class="flex-row">
        <div class="flex-item">
          <label data-i18n="bankroll">Banca (â‚¬)</label>
          <input id="bankroll" type="number" step="0.01">
        </div>

        <div class="flex-item">
          <label data-i18n="baseProfit">Lucro Base (â‚¬)</label>
          <input id="baseProfit" type="number" step="0.01">
        </div>

        <div class="flex-item">
          <label data-i18n="accumulatedLoss">Perdas acumuladas</label>
          <input id="currentLoss" disabled>
        </div>

        <div class="flex-item">
          <label data-i18n="martingaleStep">Passo Martingale</label>
          <input id="martingaleStep" disabled>
        </div>

        <div class="flex-item">
          <label data-i18n="initialBankroll">Banca inicial (â‚¬)</label>
          <input id="initialBankroll" disabled>
        </div>
      </div>

      <button class="primary" onclick="saveSettings()" data-i18n="save">Guardar</button>
      <button class="small" onclick="resetSeries()" data-i18n="reset">Reiniciar sÃ©rie</button>
    </div>


    <!-- NOVA APOSTA -->
    <div class="card">
      <h2 data-i18n="newBet">Nova Aposta</h2>

      <label data-i18n="todayMatches">Jogos de hoje</label>
      <select id="todayMatchSelect">
        <option value="" data-i18n="selectMatch">â€” Selecionar â€”</option>
      </select>

      <label data-i18n="description">Jogo / DescriÃ§Ã£o</label>
      <input id="match" placeholder="Equipa A vs Equipa B">

      <div class="flex-row">
        <div class="flex-item">
          <label data-i18n="market">Mercado</label>
          <input id="market" value="BTTS">
        </div>

        <div class="flex-item">
          <label data-i18n="selection">SeleÃ§Ã£o</label>
          <select id="selection">
            <option value="BTTS-SIM">BTTS â€“ SIM</option>
            <option value="BTTS-NAO">BTTS â€“ NÃƒO</option>
          </select>
        </div>

        <div class="flex-item">
          <label data-i18n="odd">Odd</label>
          <input id="odd" type="number" step="0.001">
        </div>
      </div>

      <button class="primary" onclick="calculateStake()" data-i18n="calcStake">Calcular stake</button>
      <p id="calcResult"></p>
      <button class="primary" onclick="addBet()" data-i18n="registerBet">Registar Aposta</button>
    </div>


    <!-- ESTATÃSTICAS -->
    <div class="card">
      <h2 data-i18n="statistics">EstatÃ­sticas</h2>
      <div class="flex-row">

        <div class="stat-box">
          <div data-i18n="bankroll">Banca (â‚¬)</div>
          <b id="statBankroll">0.00 â‚¬</b>
        </div>

        <div class="stat-box">
          <div>Total lucro</div>
          <b id="statProfit">0.00 â‚¬</b>
        </div>

        <div class="stat-box">
          <div>Total apostado</div>
          <b id="statStaked">0.00 â‚¬</b>
        </div>

        <div class="stat-box">
          <div>ROI</div>
          <b id="statROI">0.00 %</b>
        </div>

        <div class="stat-box">
          <div>G/P/Pend</div>
          <b id="statCounts">0/0/0</b>
        </div>

        <div class="stat-box">
          <div>Winrate</div>
          <b id="statWinrate">0.00 %</b>
        </div>

        <div class="stat-box">
          <div>Max Loss</div>
          <b id="statMaxLoses">0</b>
        </div>

        <div class="stat-box">
          <div>Max stake</div>
          <b id="statMaxStake">0.00 â‚¬</b>
        </div>
      </div>
    </div>


    <!-- GRÃFICOS -->
    <div class="card">
      <h2>GrÃ¡ficos</h2>

      <div class="chart-container">
        <canvas id="equityChart"></canvas>
      </div>

      <div class="chart-container">
        <canvas id="resultPieChart"></canvas>
      </div>
    </div>


    <!-- HISTÃ“RICO -->
    <div class="card">
      <h2 data-i18n="history">HistÃ³rico</h2>

      <button class="small" onclick="exportCSV()">Exportar CSV</button>
      <button class="small" onclick="clearAllBets()">Limpar tudo</button>

      <div class="table-wrapper">
        <table id="betsTable">
          <thead>
            <tr>
              <th>#</th>
              <th data-i18n="date">Data</th>
              <th data-i18n="description">Jogo</th>
              <th data-i18n="market">Mercado</th>
              <th data-i18n="selection">SeleÃ§Ã£o</th>
              <th data-i18n="odd">Odd</th>
              <th>Stake</th>
              <th>Antes</th>
              <th>Depois</th>
              <th data-i18n="result">Resultado</th>
              <th>Lucro</th>
              <th>Passo</th>
              <th>AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <script>
    /* ================================
       CONFIG GERAL
    ================================== */
    const API_DB_BASE_URL = "https://martingale-db.pflm-bet.workers.dev";
    const API_FOOTBALL_BASE_URL = "https://martingale-api.pflm-bet.workers.dev";

    let settings = {
      bankroll: 10,
      baseProfit: 0.20,
      currentLoss: 0,
      martingaleStep: 1,
      initialBankroll: null
    };

    let bets = [];
    let equityChart = null;
    let resultPieChart = null;
    let isLoading = false;
    let lastCalculatedStake = null;
    let currentLang = "pt";

    const translations = {
      pt: {
        title: "Registo Apostas Martingale",
        config: "ConfiguraÃ§Ã£o",
        bankroll: "Banca (â‚¬)",
        baseProfit: "Lucro Base (â‚¬)",
        accumulatedLoss: "Perdas acumuladas",
        martingaleStep: "Passo Martingale",
        initialBankroll: "Banca inicial (â‚¬)",
        save: "Guardar",
        reset: "Reiniciar sÃ©rie",
        newBet: "Nova Aposta",
        todayMatches: "Jogos de hoje",
        selectMatch: "â€” Selecionar â€”",
        description: "Jogo / DescriÃ§Ã£o",
        market: "Mercado",
        selection: "SeleÃ§Ã£o",
        odd: "Odd",
        calcStake: "Calcular stake",
        registerBet: "Registar Aposta",
        statistics: "EstatÃ­sticas",
        history: "HistÃ³rico",
        date: "Data",
        result: "Resultado",
        win: "Ganha",
        lose: "Perdida",
        pending: "Pendente"
      },
      en: {
        title: "Martingale Betting Tracker + ROI",
        config: "Configuration",
        bankroll: "Bankroll (â‚¬)",
        baseProfit: "Base Profit (â‚¬)",
        accumulatedLoss: "Accumulated Loss",
        martingaleStep: "Martingale Step",
        initialBankroll: "Initial Bankroll (â‚¬)",
        save: "Save",
        reset: "Reset Series",
        newBet: "New Bet",
        todayMatches: "Today's Matches",
        selectMatch: "â€” Select â€”",
        description: "Match / Description",
        market: "Market",
        selection: "Selection",
        odd: "Odds",
        calcStake: "Calculate Stake",
        registerBet: "Register Bet",
        statistics: "Statistics",
        history: "History",
        date: "Date",
        result: "Result",
        win: "Win",
        lose: "Lost",
        pending: "Pending"
      }
    };

    function toNumber(v, fallback = 0) {
      const n = parseFloat(v);
      return isNaN(n) ? fallback : n;
    }

    /* ================================
       TEMA CLARO / ESCURO
    ================================== */
    function applyTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("martingale_theme", theme);

      const btn = document.getElementById("themeBtn");
      if (!btn) return;
      if (theme === "light") {
        btn.textContent = currentLang === "pt" ? "ðŸŒž Claro" : "ðŸŒž Light";
      } else {
        btn.textContent = currentLang === "pt" ? "ðŸŒ™ Escuro" : "ðŸŒ™ Dark";
      }
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute("data-theme") || "dark";
      applyTheme(current === "dark" ? "light" : "dark");
    }

    /* ================================
       TRADUÃ‡ÃƒO PT / EN
    ================================== */
    function applyTranslations(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;

      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        const text = translations[lang][key];
        if (text) el.textContent = text;
      });

      // Atualizar texto do botÃ£o de tema
      applyTheme(document.documentElement.getAttribute("data-theme") || "dark");

      localStorage.setItem("martingale_lang", lang);
    }

    /* ================================
       SETTINGS â€” D1
    ================================== */
    async function loadSettingsFromDB() {
      try {
        const res = await fetch(`${API_DB_BASE_URL}/settings`);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        if (!data || Object.keys(data).length === 0) return;

        settings.bankroll        = toNumber(data.bankroll, settings.bankroll);
        settings.baseProfit      = toNumber(data.baseProfit, settings.baseProfit);
        settings.currentLoss     = toNumber(data.currentLoss, settings.currentLoss);
        settings.martingaleStep  = toNumber(data.martingaleStep, settings.martingaleStep);
        settings.initialBankroll = data.initialBankroll
          ? toNumber(data.initialBankroll)
          : settings.initialBankroll;

      } catch (e) {
        console.error("Erro a carregar settings:", e);
      }
    }

    async function saveSettingsToDB() {
      try {
        await fetch(`${API_DB_BASE_URL}/settings`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(settings)
        });
      } catch (e) {
        console.error("Erro ao gravar settings:", e);
      }
    }

    function updateConfigUI() {
      bankroll.value        = settings.bankroll.toFixed(2);
      baseProfit.value      = settings.baseProfit.toFixed(2);
      currentLoss.value     = settings.currentLoss.toFixed(2);
      martingaleStep.value  = settings.martingaleStep;
      initialBankroll.value = settings.initialBankroll != null
        ? settings.initialBankroll.toFixed(2)
        : "";
    }

    async function saveSettings() {
      settings.bankroll   = toNumber(bankroll.value);
      settings.baseProfit = toNumber(baseProfit.value);

      if (!settings.initialBankroll)
        settings.initialBankroll = settings.bankroll;

      await saveSettingsToDB();
      updateConfigUI();
      computeAndUpdateStats();
    }

    async function resetSeries() {
      settings.currentLoss = 0;
      settings.martingaleStep = 1;
      await saveSettingsToDB();
      updateConfigUI();
      computeAndUpdateStats();
    }

    /* ================================
       APOSTAS â€” D1
    ================================== */
    async function loadBetsFromDB() {
      try {
        const res = await fetch(`${API_DB_BASE_URL}/bets`);
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        bets = data.map(b => ({
          id: b.id,
          datetime: b.datetime,
          displayDatetime: b.displayDatetime,
          match: b.match,
          market: b.market,
          selection: b.selection,
          odd: toNumber(b.odd),
          stake: toNumber(b.stake),
          bankrollBefore: toNumber(b.bankrollBefore),
          bankrollAfter: toNumber(b.bankrollAfter),
          result: b.result,
          profit: toNumber(b.profit),
          martingaleStep: b.martingaleStep
        }));

      } catch (e) {
        console.error("Erro a carregar apostas:", e);
        bets = [];
      }
    }

    async function addBetToDB(bet) {
      await fetch(`${API_DB_BASE_URL}/bets`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(bet)
      });
      await loadBetsFromDB();
    }

    async function updateBetInDB(bet) {
      await fetch(`${API_DB_BASE_URL}/bets/${bet.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          bankrollAfter: bet.bankrollAfter,
          result: bet.result,
          profit: bet.profit,
          martingaleStep: bet.martingaleStep
        })
      });
    }

    async function deleteBetFromDB(id) {
      await fetch(`${API_DB_BASE_URL}/bets/${id}`, {
        method: "DELETE"
      });
      await loadBetsFromDB();
    }

    /* ================================
       CALCULAR STAKE
    ================================== */
    function calculateStake() {
      const oddVal = toNumber(odd.value);

      if (!oddVal || oddVal <= 1) {
        calcResult.innerHTML =
          "<span style='color:var(--danger)'>Odd invÃ¡lida.</span>";
        return;
      }

      const stake = (settings.currentLoss + settings.baseProfit) / (oddVal - 1);
      lastCalculatedStake = stake;

      calcResult.innerHTML = `Stake recomendada: <b>${stake.toFixed(2)} â‚¬</b>`;
    }

    /* ================================
       REGISTAR APOSTA
    ================================== */
    async function addBet() {
      if (isLoading) return;

      const oddVal = toNumber(odd.value);
      const stake  = lastCalculatedStake;
      const matchValue = match.value.trim();

      if (!matchValue || !oddVal || !stake) {
        alert("Preencha jogo, odd e calcule a stake.");
        return;
      }

      const bet = {
        datetime: new Date().toISOString(),
        displayDatetime: new Date().toLocaleString("pt-PT"),
        match: matchValue,
        market: market.value,
        selection: selection.value,
        odd: oddVal,
        stake: stake,
        bankrollBefore: settings.bankroll,
        bankrollAfter: settings.bankroll,
        result: "Pendente",
        profit: 0,
        martingaleStep: settings.martingaleStep
      };

      isLoading = true;
      await addBetToDB(bet);
      isLoading = false;

      renderBetsTable();
      computeAndUpdateStats();

      todayMatchSelect.value = "";
      match.value = "";
      odd.value = "";
      calcResult.innerHTML = "";
      lastCalculatedStake = null;
    }

    /* ================================
       ATUALIZAR RESULTADO (corrigido)
    ================================== */
    async function setBetResult(index, outcome) {
      const bet = bets[index];
      if (!bet) return;

      const oddVal = bet.odd;
      const stake  = bet.stake;

      if (bet.result !== "Pendente") {
        if (!confirm("Alterar resultado da aposta?")) return;
      }

      if (outcome === "Ganha") {
        // LUCRO REAL: ganho bruto - stake
        const lucro = (stake * oddVal) - stake;

        settings.bankroll += lucro;
        settings.currentLoss = 0;
        settings.martingaleStep = 1;

        bet.result = "Ganha";
        bet.profit = lucro;
        bet.bankrollAfter = settings.bankroll;

      } else {
        settings.bankroll -= stake;
        settings.currentLoss += stake;
        settings.martingaleStep++;

        bet.result = "Perdida";
        bet.profit = -stake;
        bet.bankrollAfter = settings.bankroll;
      }

      bet.martingaleStep = settings.martingaleStep;

      await saveSettingsToDB();
      await updateBetInDB(bet);

      updateConfigUI();
      renderBetsTable();
      computeAndUpdateStats();
    }

    /* ================================
       APAGAR APOSTA
    ================================== */
    async function deleteBet(index) {
      if (!confirm("Apagar esta aposta?")) return;
      const bet = bets[index];
      await deleteBetFromDB(bet.id);
      renderBetsTable();
      computeAndUpdateStats();
    }

    /* ================================
       RENDER TABELA
    ================================== */
    function renderBetsTable() {
      const tbody = document.querySelector("#betsTable tbody");
      tbody.innerHTML = "";

      bets.forEach((b, i) => {
        const cls =
          b.result === "Ganha"   ? "status-ganha" :
          b.result === "Perdida" ? "status-perdida" :
                                   "status-pendente";

        // Texto do resultado dependente de idioma
        let resultLabel = b.result;
        if (currentLang === "en") {
          if (b.result === "Ganha")   resultLabel = translations.en.win;
          if (b.result === "Perdida") resultLabel = translations.en.lose;
          if (b.result === "Pendente")resultLabel = translations.en.pending;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${b.id}</td>
          <td>${b.displayDatetime}</td>
          <td>${b.match}</td>
          <td>${b.market}</td>
          <td>${b.selection}</td>
          <td>${b.odd.toFixed(3)}</td>
          <td>${b.stake.toFixed(2)}</td>
          <td>${b.bankrollBefore.toFixed(2)}</td>
          <td>${b.bankrollAfter.toFixed(2)}</td>
          <td class="${cls}">${resultLabel}</td>
          <td>${b.profit.toFixed(2)}</td>
          <td>${b.martingaleStep}</td>
          <td>
            <button class="small" onclick="setBetResult(${i}, 'Ganha')">Ganha</button>
            <button class="small" onclick="setBetResult(${i}, 'Perdida')">Perdida</button>
            <button class="small" style="background:var(--danger)"
                    onclick="deleteBet(${i})">ðŸ—‘</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ================================
       ESTATÃSTICAS + GRÃFICOS
    ================================== */
    function computeAndUpdateStats() {
      const settled = bets.filter(b => b.result !== "Pendente");
      const totalStaked = settled.reduce((a,b)=>a + b.stake, 0);
      const totalProfit = settled.reduce((a,b)=>a + b.profit, 0);
      const wins   = settled.filter(b => b.result === "Ganha").length;
      const losses = settled.filter(b => b.result === "Perdida").length;
      const pending = bets.length - settled.length;

      statProfit.textContent   = totalProfit.toFixed(2) + " â‚¬";
      statStaked.textContent   = totalStaked.toFixed(2) + " â‚¬";
      statCounts.textContent   = `${wins}/${losses}/${pending}`;
      statROI.textContent      = ((totalProfit / (totalStaked || 1)) * 100).toFixed(2) + " %";
      statWinrate.textContent  = ((wins / (settled.length || 1)) * 100).toFixed(2) + " %";
      statBankroll.textContent = settings.bankroll.toFixed(2) + " â‚¬";

      // Max perda consecutiva
      let maxLoseStreak = 0;
      let currentStreak = 0;
      const sorted = bets.slice().sort(
        (a,b) => new Date(a.datetime) - new Date(b.datetime)
      );
      sorted.forEach(b => {
        if (b.result === "Perdida") {
          currentStreak++;
          if (currentStreak > maxLoseStreak) maxLoseStreak = currentStreak;
        } else if (b.result === "Ganha") {
          currentStreak = 0;
        }
      });
      statMaxLoses.textContent = maxLoseStreak.toString();

      // Max stake
      const maxStake = bets.reduce((m,b)=> Math.max(m, b.stake||0), 0);
      statMaxStake.textContent = maxStake.toFixed(2) + " â‚¬";

      updateCharts(settled);
    }

    function updateCharts(settled) {
      // Equity
      const sorted = settled.slice().sort(
        (a,b) => new Date(a.datetime) - new Date(b.datetime)
      );

      const eqLabels = [];
      const eqData   = [];

      let base = settings.initialBankroll || settings.bankroll;
      eqLabels.push("Start");
      eqData.push(base);

      sorted.forEach(b => {
        eqLabels.push(new Date(b.datetime).toLocaleString("pt-PT"));
        eqData.push(b.bankrollAfter);
      });

      if (equityChart) equityChart.destroy();
      const ctxEq = document.getElementById("equityChart").getContext("2d");
      equityChart = new Chart(ctxEq, {
        type: "line",
        data: {
          labels: eqLabels,
          datasets: [{
            label: "Banca (â‚¬)",
            data: eqData,
            borderColor: "#2d7ef7",
            backgroundColor: "rgba(45,126,247,0.15)",
            fill: true,
            tension: 0.25,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false
        }
      });

      // Pie resultados
      const wins   = settled.filter(b => b.result==="Ganha").length;
      const losses = settled.filter(b => b.result==="Perdida").length;
      const pending = bets.filter(b => b.result==="Pendente").length;

      if (resultPieChart) resultPieChart.destroy();
      const ctxPie = document.getElementById("resultPieChart").getContext("2d");
      resultPieChart = new Chart(ctxPie, {
        type: "pie",
        data: {
          labels: [
            currentLang === "pt" ? "Ganha"   : translations.en.win,
            currentLang === "pt" ? "Perdida" : translations.en.lose,
            currentLang === "pt" ? "Pendente": translations.en.pending
          ],
          datasets: [{
            data: [wins, losses, pending],
            backgroundColor: ["#2ecc71", "#e74c3c", "#f1c40f"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false
        }
      });
    }

    /* ================================
       EXPORTAÃ‡ÃƒO CSV
    ================================== */
    function exportCSV() {
      let csv = "ID;Data;Jogo;Mercado;SeleÃ§Ã£o;Odd;Stake;Antes;Depois;Resultado;Lucro;Passo\n";
      bets.forEach(b => {
        csv += `${b.id};${b.displayDatetime};${b.match};${b.market};${b.selection};${b.odd};${b.stake};${b.bankrollBefore};${b.bankrollAfter};${b.result};${b.profit};${b.martingaleStep}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url  = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "apostas_martingale.csv";
      a.click();
    }

    /* ================================
       LIMPAR HISTÃ“RICO
    ================================== */
    async function clearAllBets() {
      if (!confirm("Tem a certeza que deseja APAGAR todo o histÃ³rico?")) return;
      for (const b of bets) {
        await deleteBetFromDB(b.id);
      }
      bets = [];
      renderBetsTable();
      computeAndUpdateStats();
    }

    /* ================================
       JOGOS DO DIA â€” API WORKER
    ================================== */
    async function loadTodayMatches() {
      const sel = document.getElementById("todayMatchSelect");
      sel.innerHTML = "<option value=''>A carregar...</option>";

      const date = new Date().toISOString().slice(0, 10);

      try {
        const res = await fetch(`${API_FOOTBALL_BASE_URL}/?date=${date}`);
        const data = await res.json();
        const fixtures = data.response || [];

        if (!fixtures.length) {
          sel.innerHTML = "<option value=''>Sem jogos hoje</option>";
          return;
        }

        sel.innerHTML = "<option value='' data-i18n='selectMatch'>â€” Selecionar â€”</option>";

        fixtures.forEach(f => {
          const time = new Date(f.fixture.date)
            .toLocaleTimeString("pt-PT", { hour: "2-digit", minute: "2-digit" });

          const txt = `${f.teams.home.name} vs ${f.teams.away.name}`;
          const opt = document.createElement("option");
          opt.value = txt;
          opt.textContent = `${time} â€” ${txt} (${f.league.name})`;
          sel.appendChild(opt);
        });

      } catch (e) {
        console.error("Erro jogos:", e);
        sel.innerHTML = "<option value=''>Erro ao carregar jogos</option>";
      }
    }

    /* ================================
       INICIALIZAÃ‡ÃƒO GERAL
    ================================== */
    window.onload = async () => {
      const themeBtn = document.getElementById("themeBtn");
      const langSwitcher = document.getElementById("langSwitcher");

      // Idioma
      const savedLang = localStorage.getItem("martingale_lang") || "pt";
      langSwitcher.value = savedLang;
      applyTranslations(savedLang);

      langSwitcher.addEventListener("change", e => {
        applyTranslations(e.target.value);
        computeAndUpdateStats();
        renderBetsTable();
      });

      // Tema
      const savedTheme = localStorage.getItem("martingale_theme") || "dark";
      applyTheme(savedTheme);
      themeBtn.addEventListener("click", toggleTheme);

      // Carregar settings + apostas
      await loadSettingsFromDB();
      await loadBetsFromDB();

      updateConfigUI();
      renderBetsTable();
      computeAndUpdateStats();

      // Jogos do dia
      loadTodayMatches();
      todayMatchSelect.onchange = () => {
        if (todayMatchSelect.value)
          match.value = todayMatchSelect.value;
      };
    };
    </script>
  </div>
</body>
</html>
