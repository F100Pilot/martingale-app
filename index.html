<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Registo Apostas Martingale + ROI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: Arial; background:#111; color:#eee; margin:20px; }
    h1,h2 { text-align:center; }
    .card { background:#1b1b1b; padding:15px; border-radius:8px; margin-bottom:20px; }
    input,select,button { width:100%; padding:6px; margin-top:4px; border-radius:4px; border:1px solid #444; background:#222; color:#eee; }
    button.primary { background:#2d7ef7; border:none; font-weight:bold; }
    button.small { width:auto; padding:4px 8px; font-size:0.75rem; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border:1px solid #444; padding:4px; text-align:center; }
    .status-ganha { color:#2ecc71; }
    .status-perdida { color:#e74c3c; }
    .status-pendente { color:#f1c40f; }
    .flex-row { display:flex; gap:10px; flex-wrap:wrap; }
    .flex-item { flex:1 1 200px; }
    canvas { background:#181818; border-radius:6px; padding:6px; }
    .stat-box { background:#181818; padding:8px; border-radius:6px; text-align:center; }
  </style>
</head>
<body>

<h1>Registo Apostas Martingale</h1>

<!-- CONFIG -->
<div class="card">
  <h2>Configuração</h2>
  <div class="flex-row">
    <div class="flex-item">
      <label>Banca (€)</label>
      <input id="bankroll" type="number" step="0.01" />
    </div>
    <div class="flex-item">
      <label>Lucro base (€)</label>
      <input id="baseProfit" type="number" step="0.01" />
    </div>
    <div class="flex-item">
      <label>Perdas acumuladas</label>
      <input id="currentLoss" disabled />
    </div>
    <div class="flex-item">
      <label>Passo Martingale</label>
      <input id="martingaleStep" disabled />
    </div>
    <div class="flex-item">
      <label>Banca inicial (€)</label>
      <input id="initialBankroll" disabled />
    </div>
  </div>
  <button class="primary" onclick="saveSettings()">Guardar</button>
  <button class="small" onclick="resetSeries()">Reiniciar série</button>
</div>

<!-- NOVA APOSTA -->
<div class="card">
  <h2>Nova Aposta</h2>

  <label>Jogos de hoje</label>
  <select id="todayMatchSelect">
    <option value="">A carregar...</option>
  </select>

  <label>Jogo / Descrição</label>
  <input id="match" type="text" placeholder="Equipa A vs Equipa B" />

  <div class="flex-row">
    <div class="flex-item">
      <label>Mercado</label>
      <input id="market" type="text" value="BTTS" />
    </div>
    <div class="flex-item">
      <label>Seleção</label>
      <select id="selection">
        <option value="BTTS-SIM">BTTS – SIM</option>
        <option value="BTTS-NAO">BTTS – NÃO</option>
      </select>
    </div>
    <div class="flex-item">
      <label>Odd</label>
      <input id="odd" type="number" step="0.001" />
    </div>
  </div>

  <button class="primary" onclick="calculateStake()">Calcular stake</button>
  <p id="calcResult"></p>
  <button class="primary" onclick="addBet()">Registar aposta</button>
</div>

<!-- ESTATÍSTICAS -->
<div class="card">
  <h2>Estatísticas</h2>
  <div class="flex-row">
    <div class="stat-box">
      <div>Banca:</div><b id="statBankroll">0.00 €</b>
    </div>
    <div class="stat-box"><div>Lucro total:</div><b id="statProfit">0.00 €</b></div>
    <div class="stat-box"><div>Total apostado:</div><b id="statStaked">0.00 €</b></div>
    <div class="stat-box"><div>ROI:</div><b id="statROI">0.00 %</b></div>
    <div class="stat-box"><div>G / P / Pend:</div><b id="statCounts">0/0/0</b></div>
    <div class="stat-box"><div>Winrate:</div><b id="statWinrate">0.00 %</b></div>
    <div class="stat-box"><div>Max Loss Streak:</div><b id="statMaxLoses">0</b></div>
    <div class="stat-box"><div>Max Stake:</div><b id="statMaxStake">0.00 €</b></div>
  </div>
</div>

<!-- GRÁFICOS -->
<div class="card">
  <h2>Gráficos</h2>
  <canvas id="equityChart"></canvas><br>
  <canvas id="profitByDayChart"></canvas><br>
  <canvas id="resultPieChart"></canvas><br>
  <canvas id="oddHistogramChart"></canvas>
</div>

<!-- HISTÓRICO -->
<div class="card">
  <h2>Histórico</h2>
  <button class="small" onclick="exportCSV()">Exportar CSV</button>
  <button class="small" onclick="clearAllBets()">Limpar tudo</button>

  <table id="betsTable">
    <thead>
      <tr>
        <th>#</th><th>Data</th><th>Jogo</th><th>Mercado</th><th>Seleção</th>
        <th>Odd</th><th>Stake</th><th>Antes</th><th>Depois</th>
        <th>Resultado</th><th>Lucro</th><th>Passo</th><th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
/* --------------------------------------------------
   1. CONFIG DO PROXY (CORS OK)
-------------------------------------------------- */
const API_FOOTBALL_BASE_URL = "https://martingale-api.pflm-bet.workers.dev";

/* --------------------------------------------------
   2. ESTADO GLOBAL
-------------------------------------------------- */
let settings = { bankroll:0, baseProfit:0.2, currentLoss:0, martingaleStep:1, initialBankroll:null };
let bets = [];
let equityChart, profitByDayChart, resultPieChart, oddHistogramChart;

/* --------------------------------------------------
   3. STORAGE
-------------------------------------------------- */
function loadFromStorage(){
  const s = localStorage.getItem("martingale_settings_v2");
  const b = localStorage.getItem("martingale_bets_v2");
  if(s) settings = JSON.parse(s);
  if(b) bets = JSON.parse(b);

  if(settings.initialBankroll == null && settings.bankroll > 0)
    settings.initialBankroll = settings.bankroll;
}

function saveToStorage(){
  localStorage.setItem("martingale_settings_v2", JSON.stringify(settings));
  localStorage.setItem("martingale_bets_v2", JSON.stringify(bets));
}

/* --------------------------------------------------
   4. UI
-------------------------------------------------- */
function updateConfigUI(){
  bankroll.value = settings.bankroll.toFixed(2);
  baseProfit.value = settings.baseProfit.toFixed(2);
  currentLoss.value = settings.currentLoss.toFixed(2);
  martingaleStep.value = settings.martingaleStep;
  initialBankroll.value = settings.initialBankroll ?? "";

  statBankroll.textContent = settings.bankroll.toFixed(2)+" €";
}

function saveSettings(){
  settings.bankroll = parseFloat(bankroll.value)||0;
  settings.baseProfit = parseFloat(baseProfit.value)||0;
  if(settings.initialBankroll==null) settings.initialBankroll = settings.bankroll;
  saveToStorage();
  updateConfigUI();
  computeAndUpdateStats();
}

function resetSeries(){
  settings.currentLoss = 0;
  settings.martingaleStep = 1;
  saveToStorage();
  updateConfigUI();
  computeAndUpdateStats();
}

/* --------------------------------------------------
   5. STAKE
-------------------------------------------------- */
function calculateStake(){
  const odd = parseFloat(document.getElementById("odd").value);
  const perdas = settings.currentLoss;
  const base = settings.baseProfit;
  const stake = (perdas + base) / (odd - 1);

  window.lastCalculatedStake = stake;

  calcResult.innerHTML = `Stake recomendada: <b>${stake.toFixed(2)} €</b>`;
}

/* --------------------------------------------------
   6. REGISTO DA APOSTA
-------------------------------------------------- */
function addBet(){
  const odd = parseFloat(document.getElementById("odd").value);
  const stake = window.lastCalculatedStake;

  const bet = {
    id:bets.length+1,
    datetime:new Date().toISOString(),
    displayDatetime:new Date().toLocaleString(),
    match:match.value,
    market:market.value,
    selection:selection.value,
    odd,
    stake,
    bankrollBefore:settings.bankroll,
    bankrollAfter:settings.bankroll,
    result:"Pendente",
    profit:0,
    martingaleStep:settings.martingaleStep
  };

  bets.push(bet);
  saveToStorage();
  renderBetsTable();
  computeAndUpdateStats();
}

/* --------------------------------------------------
   7. PROCESSAR RESULTADO
-------------------------------------------------- */
function setBetResult(index,outcome){
  const bet = bets[index];
  const odd = bet.odd;
  const stake = bet.stake;

  if(outcome=="Ganha"){
    const lucro = stake*(odd-1)-settings.currentLoss;
    settings.bankroll += lucro;
    settings.currentLoss = 0;
    settings.martingaleStep = 1;
    bet.result="Ganha";
    bet.profit=lucro;
    bet.bankrollAfter=settings.bankroll;
  } else {
    settings.bankroll -= stake;
    settings.currentLoss+=stake;
    settings.martingaleStep++;
    bet.result="Perdida";
    bet.profit=-stake;
    bet.bankrollAfter=settings.bankroll;
  }

  saveToStorage();
  renderBetsTable();
  computeAndUpdateStats();
}

/* --------------------------------------------------
   8. TABELA
-------------------------------------------------- */
function renderBetsTable(){
  const tbody=document.querySelector("#betsTable tbody");
  tbody.innerHTML="";
  bets.forEach((b,i)=>{
    const cls = b.result=="Ganha"?"status-ganha":b.result=="Perdida"?"status-perdida":"status-pendente";
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${b.id}</td><td>${b.displayDatetime}</td><td>${b.match}</td>
      <td>${b.market}</td><td>${b.selection}</td><td>${b.odd.toFixed(3)}</td>
      <td>${b.stake.toFixed(2)}</td><td>${b.bankrollBefore.toFixed(2)}</td>
      <td>${b.bankrollAfter.toFixed(2)}</td><td class="${cls}">${b.result}</td>
      <td>${b.profit.toFixed(2)}</td><td>${b.martingaleStep}</td>
      <td>
        <button class="small" onclick="setBetResult(${i},'Ganha')">Ganha</button>
        <button class="small" onclick="setBetResult(${i},'Perdida')">Perdida</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* --------------------------------------------------
   9. ESTATÍSTICAS + GRÁFICOS
-------------------------------------------------- */
function computeAndUpdateStats(){
  const settled=bets.filter(b=>b.result!="Pendente");
  const totalStaked=settled.reduce((a,b)=>a+b.stake,0);
  const totalProfit=settled.reduce((a,b)=>a+b.profit,0);
  const wins=settled.filter(b=>b.result=="Ganha").length;
  const losses=settled.filter(b=>b.result=="Perdida").length;
  const pending=bets.length-settled.length;

  statProfit.textContent=totalProfit.toFixed(2)+" €";
  statStaked.textContent=totalStaked.toFixed(2)+" €";
  statCounts.textContent=`${wins}/${losses}/${pending}`;
  statROI.textContent=((totalProfit/totalStaked)*100||0).toFixed(2)+" %";
  statWinrate.textContent=((wins/settled.length)*100||0).toFixed(2)+" %";
  statBankroll.textContent=settings.bankroll.toFixed(2)+" €";

  updateCharts(settled);
}

function updateCharts(settled){
  // ORDER BY DATE
  const sorted=settled.slice().sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));

  // EQUITY
  const eqLabels=["Start"];
  const eqData=[settings.initialBankroll];
  sorted.forEach(b=>{
    eqLabels.push(new Date(b.datetime).toLocaleString());
    eqData.push(b.bankrollAfter);
  });

  const ctx1=equityChart?equityChart.destroy():null;
  equityChart=new Chart(document.getElementById("equityChart"),{
    type:"line",
    data:{labels:eqLabels,datasets:[{label:"Banca (€)",data:eqData}]},
    options:{responsive:true}
  });

  // RESULT PIE
  const wins=settled.filter(b=>b.result=="Ganha").length;
  const losses=settled.filter(b=>b.result=="Perdida").length;
  const pending=bets.filter(b=>b.result=="Pendente").length;

  if(resultPieChart) resultPieChart.destroy();
  resultPieChart=new Chart(document.getElementById("resultPieChart"),{
    type:"pie",
    data:{labels:["Ganha","Perdida","Pendente"],datasets:[{data:[wins,losses,pending]}]}
  });
}

/* --------------------------------------------------
   10. EXPORT CSV
-------------------------------------------------- */
function exportCSV(){
  let csv="ID;Data;Jogo;Mercado;Seleção;Odd;Stake;Antes;Depois;Resultado;Lucro;Passo\n";
  bets.forEach(b=>{
    csv+=`${b.id};${b.displayDatetime};${b.match};${b.market};${b.selection};${b.odd};${b.stake};${b.bankrollBefore};${b.bankrollAfter};${b.result};${b.profit};${b.martingaleStep}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="apostas.csv";
  a.click();
}

/* --------------------------------------------------
   11. LIMPAR TUDO
-------------------------------------------------- */
function clearAllBets(){
  if(!confirm("Apagar tudo?")) return;
  bets=[];
  saveToStorage();
  renderBetsTable();
  computeAndUpdateStats();
}

/* --------------------------------------------------
   12. CARREGAR JOGOS DO DIA (WORKER)
-------------------------------------------------- */
async function loadTodayMatches(){
  const sel=document.getElementById("todayMatchSelect");
  sel.innerHTML = "<option>A carregar...</option>";

  const now=new Date();
  const d=now.toISOString().slice(0,10);

  try{
    const res=await fetch(`${API_FOOTBALL_BASE_URL}/?date=${d}`);
    const data=await res.json();
    const fixtures=data.response||[];

    if(!fixtures.length){
      sel.innerHTML="<option>Sem jogos hoje</option>";
      return;
    }

    sel.innerHTML="<option value=''>-- Escolhe um jogo --</option>";

    fixtures.forEach(f=>{
      const t=new Date(f.fixture.date).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
      const val=`${f.teams.home.name} vs ${f.teams.away.name}`;
      const opt=document.createElement("option");
      opt.value=val;
      opt.textContent=`${t} - ${val} (${f.league.name})`;
      sel.appendChild(opt);
    });
  }catch(e){
    sel.innerHTML="<option>Erro ao carregar jogos</option>";
  }
}

/* --------------------------------------------------
   13. INICIAR
-------------------------------------------------- */
window.onload=()=>{
  loadFromStorage();
  updateConfigUI();
  renderBetsTable();
  computeAndUpdateStats();
  loadTodayMatches();

  todayMatchSelect.addEventListener("change",()=>{
    if(todayMatchSelect.value)
      match.value=todayMatchSelect.value;
  });
};
</script>

</body>
</html>
