<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Registo Apostas Martingale + ROI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: Arial; background:#111; color:#eee; margin:20px; }
    h1,h2 { text-align:center; }
    .card { background:#1b1b1b; padding:15px; border-radius:8px; margin-bottom:20px; }
    input,select,button { width:100%; padding:6px; margin-top:4px; border-radius:4px; border:1px solid #444; background:#222; color:#eee; }
    button.primary { background:#2d7ef7; border:none; font-weight:bold; }
    button.small { width:auto; padding:4px 8px; font-size:0.75rem; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border:1px solid #444; padding:4px; text-align:center; }
    .status-ganha { color:#2ecc71; }
    .status-perdida { color:#e74c3c; }
    .status-pendente { color:#f1c40f; }
    .flex-row { display:flex; gap:10px; flex-wrap:wrap; }
    .flex-item { flex:1 1 200px; }
    canvas { background:#181818; border-radius:6px; padding:6px; }
    .stat-box { background:#181818; padding:8px; border-radius:6px; text-align:center; }
  </style>
</head>
<body>

<h1>Registo Apostas Martingale</h1>

<!-- CONFIGURA√á√ÉO -->
<div class="card">
  <h2>Configura√ß√£o</h2>
  <div class="flex-row">
    <div class="flex-item">
      <label>Banca (‚Ç¨)</label>
      <input id="bankroll" type="number" step="0.01" />
    </div>
    <div class="flex-item">
      <label>Lucro base (‚Ç¨)</label>
      <input id="baseProfit" type="number" step="0.01" />
    </div>
    <div class="flex-item">
      <label>Perdas acumuladas</label>
      <input id="currentLoss" disabled />
    </div>
    <div class="flex-item">
      <label>Passo Martingale</label>
      <input id="martingaleStep" disabled />
    </div>
    <div class="flex-item">
      <label>Banca inicial (‚Ç¨)</label>
      <input id="initialBankroll" disabled />
    </div>
  </div>
  <button class="primary" onclick="saveSettings()">Guardar</button>
  <button class="small" onclick="resetSeries()">Reiniciar s√©rie</button>
</div>

<!-- NOVA APOSTA -->
<div class="card">
  <h2>Nova Aposta</h2>

  <label>Jogos de hoje</label>
  <select id="todayMatchSelect">
    <option value="">A carregar...</option>
  </select>

  <label>Jogo / Descri√ß√£o</label>
  <input id="match" type="text" placeholder="Equipa A vs Equipa B" />

  <div class="flex-row">
    <div class="flex-item">
      <label>Mercado</label>
      <input id="market" type="text" value="BTTS" />
    </div>
    <div class="flex-item">
      <label>Sele√ß√£o</label>
      <select id="selection">
        <option value="BTTS-SIM">BTTS ‚Äì SIM</option>
        <option value="BTTS-NAO">BTTS ‚Äì N√ÉO</option>
      </select>
    </div>
    <div class="flex-item">
      <label>Odd</label>
      <input id="odd" type="number" step="0.001" />
    </div>
  </div>

  <button class="primary" onclick="calculateStake()">Calcular stake</button>
  <p id="calcResult"></p>
  <button class="primary" onclick="addBet()">Registar aposta</button>
</div>

<!-- ESTAT√çSTICAS -->
<div class="card">
  <h2>Estat√≠sticas</h2>
  <div class="flex-row">
    <div class="stat-box"><div>Banca:</div><b id="statBankroll">0.00 ‚Ç¨</b></div>
    <div class="stat-box"><div>Lucro total:</div><b id="statProfit">0.00 ‚Ç¨</b></div>
    <div class="stat-box"><div>Total apostado:</div><b id="statStaked">0.00 ‚Ç¨</b></div>
    <div class="stat-box"><div>ROI:</div><b id="statROI">0.00 %</b></div>
    <div class="stat-box"><div>G / P / Pend:</div><b id="statCounts">0/0/0</b></div>
    <div class="stat-box"><div>Winrate:</div><b id="statWinrate">0.00 %</b></div>
    <div class="stat-box"><div>Max Loss Streak:</div><b id="statMaxLoses">0</b></div>
    <div class="stat-box"><div>Max Stake:</div><b id="statMaxStake">0.00 ‚Ç¨</b></div>
  </div>
</div>

<!-- GR√ÅFICOS -->
<div class="card">
  <h2>Gr√°ficos</h2>
  <canvas id="equityChart"></canvas><br>
  <canvas id="profitByDayChart"></canvas><br>
  <canvas id="resultPieChart"></canvas><br>
  <canvas id="oddHistogramChart"></canvas>
</div>

<!-- HIST√ìRICO -->
<div class="card">
  <h2>Hist√≥rico</h2>
  <button class="small" onclick="exportCSV()">Exportar CSV</button>
  <button class="small" onclick="clearAllBets()">Limpar tudo</button>

  <table id="betsTable">
    <thead>
      <tr>
        <th>#</th><th>Data</th><th>Jogo</th><th>Mercado</th><th>Sele√ß√£o</th>
        <th>Odd</th><th>Stake</th><th>Antes</th><th>Depois</th>
        <th>Resultado</th><th>Lucro</th><th>Passo</th><th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
/* ================================
   ENDPOINTS
================================ */
const API_FOOTBALL_BASE_URL = "https://martingale-api.pflm-bet.workers.dev";
const API_DB_BASE_URL       = "https://martingale-db.pflm-bet.workers.dev";

/* ================================
   ESTADO GLOBAL
================================ */
let settings = {
  bankroll: 0,
  baseProfit: 0.2,
  currentLoss: 0,
  martingaleStep: 1,
  initialBankroll: null
};

let bets = [];
let equityChart, resultPieChart;
let isLoading = false;

/* ================================
   HELPERS
================================ */
function toNumber(v, def = 0) {
  const n = Number(v);
  return isNaN(n) ? def : n;
}
/* ================================
   SETTINGS (BD D1)
================================ */
async function loadSettingsFromDB() {
  try {
    const res = await fetch(`${API_DB_BASE_URL}/settings`);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    if (!data || Object.keys(data).length === 0) return;

    settings.bankroll        = toNumber(data.bankroll, settings.bankroll);
    settings.baseProfit      = toNumber(data.baseProfit, settings.baseProfit);
    settings.currentLoss     = toNumber(data.currentLoss, settings.currentLoss);
    settings.martingaleStep  = toNumber(data.martingaleStep, settings.martingaleStep);
    settings.initialBankroll = data.initialBankroll != null
      ? toNumber(data.initialBankroll)
      : settings.initialBankroll;
  } catch (e) {
    console.error("Erro a carregar settings da BD:", e);
  }
}

async function saveSettingsToDB() {
  try {
    await fetch(`${API_DB_BASE_URL}/settings`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        bankroll: settings.bankroll,
        baseProfit: settings.baseProfit,
        currentLoss: settings.currentLoss,
        martingaleStep: settings.martingaleStep,
        initialBankroll: settings.initialBankroll
      })
    });
  } catch (e) {
    console.error("Erro a gravar settings na BD:", e);
  }
}

/* ================================
   APOSTAS (BD D1)
================================ */
async function loadBetsFromDB() {
  try {
    const res = await fetch(`${API_DB_BASE_URL}/bets`);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    bets = data.map(r => ({
      id: r.id,
      datetime: r.datetime,
      displayDatetime: r.displayDatetime,
      match: r.match,
      market: r.market,
      selection: r.selection,
      odd: toNumber(r.odd),
      stake: toNumber(r.stake),
      bankrollBefore: toNumber(r.bankrollBefore),
      bankrollAfter: toNumber(r.bankrollAfter),
      result: r.result,
      profit: toNumber(r.profit),
      martingaleStep: r.martingaleStep
    }));
  } catch (e) {
    console.error("Erro a carregar apostas da BD:", e);
    bets = [];
  }
}

async function addBetToDB(bet) {
  await fetch(`${API_DB_BASE_URL}/bets`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(bet)
  });
  await loadBetsFromDB();  // atualizar ID real
}

async function updateBetInDB(bet) {
  await fetch(`${API_DB_BASE_URL}/bets/${bet.id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      bankrollAfter: bet.bankrollAfter,
      result: bet.result,
      profit: bet.profit,
      martingaleStep: bet.martingaleStep
    })
  });
}

async function deleteBetFromDB(id) {
  await fetch(`${API_DB_BASE_URL}/bets/${id}`, { method: "DELETE" });
  await loadBetsFromDB();
}

/* ================================
   UI CONFIG
================================ */
function updateConfigUI() {
  bankroll.value        = settings.bankroll.toFixed(2);
  baseProfit.value      = settings.baseProfit.toFixed(2);
  currentLoss.value     = settings.currentLoss.toFixed(2);
  martingaleStep.value  = settings.martingaleStep;
  initialBankroll.value = settings.initialBankroll != null
    ? settings.initialBankroll.toFixed(2)
    : "";
  statBankroll.textContent = settings.bankroll.toFixed(2) + " ‚Ç¨";
}

async function saveSettings() {
  settings.bankroll   = toNumber(bankroll.value);
  settings.baseProfit = toNumber(baseProfit.value);
  if (settings.initialBankroll == null || settings.initialBankroll === 0) {
    settings.initialBankroll = settings.bankroll;
  }
  await saveSettingsToDB();
  updateConfigUI();
  computeAndUpdateStats();
}

async function resetSeries() {
  settings.currentLoss = 0;
  settings.martingaleStep = 1;
  await saveSettingsToDB();
  updateConfigUI();
  computeAndUpdateStats();
}

/* ================================
   CALCULAR STAKE
================================ */
function calculateStake() {
  const oddVal = toNumber(document.getElementById("odd").value);
  if (!oddVal || oddVal <= 1) {
    calcResult.innerHTML = "<span style='color:#e74c3c'>Odd inv√°lida.</span>";
    return;
  }
  const stake = (settings.currentLoss + settings.baseProfit) / (oddVal - 1);
  window.lastCalculatedStake = stake;
  calcResult.innerHTML = `Stake recomendada: <b>${stake.toFixed(2)} ‚Ç¨</b>`;
}

/* ================================
   REGISTAR APOSTA
================================ */
async function addBet() {
  if (isLoading) return;
  const oddVal = toNumber(document.getElementById("odd").value);
  const stake  = window.lastCalculatedStake;
  const matchValue = document.getElementById("match").value.trim();

  if (!oddVal || !stake || !matchValue) {
    alert("Preencha jogo, odd e calcule a stake antes de registar.");
    return;
  }

  const bet = {
    datetime: new Date().toISOString(),
    displayDatetime: new Date().toLocaleString(),
    match: matchValue,
    market: market.value,
    selection: selection.value,
    odd: oddVal,
    stake: stake,
    bankrollBefore: settings.bankroll,
    bankrollAfter: settings.bankroll,
    result: "Pendente",
    profit: 0,
    martingaleStep: settings.martingaleStep
  };

  isLoading = true;
  await addBetToDB(bet);
  isLoading = false;

  renderBetsTable();
  computeAndUpdateStats();

  todayMatchSelect.value = "";
  match.value = "";
  odd.value = "";
  calcResult.innerHTML = "";
  window.lastCalculatedStake = null;
}

/* ================================
   RESULTADO DA APOSTA
================================ */
async function setBetResult(index, outcome) {
  if (index < 0 || index >= bets.length) return;
  const bet = bets[index];
  const oddVal = bet.odd;
  const stake  = bet.stake;

  if (bet.result !== "Pendente") {
    if (!confirm("Esta aposta j√° tem resultado. Alterar mesmo assim?")) return;
  }

  if (outcome === "Ganha") {
    const lucro = stake * (oddVal - 1) - settings.currentLoss;
    settings.bankroll += lucro;
    settings.currentLoss = 0;
    settings.martingaleStep = 1;

    bet.result = "Ganha";
    bet.profit = lucro;
    bet.bankrollAfter = settings.bankroll;
    bet.martingaleStep = settings.martingaleStep;
  } else {
    settings.bankroll -= stake;
    settings.currentLoss += stake;
    settings.martingaleStep++;

    bet.result = "Perdida";
    bet.profit = -stake;
    bet.bankrollAfter = settings.bankroll;
    bet.martingaleStep = settings.martingaleStep;
  }

  await Promise.all([
    saveSettingsToDB(),
    updateBetInDB(bet)
  ]);

  updateConfigUI();
  renderBetsTable();
  computeAndUpdateStats();
}

/* ================================
   APAGAR APOSTA
================================ */
async function deleteBet(index) {
  if (index < 0 || index >= bets.length) return;
  const bet = bets[index];
  if (!confirm("Tem a certeza que quer apagar esta aposta?")) return;

  await deleteBetFromDB(bet.id);
  renderBetsTable();
  computeAndUpdateStats();
}

/* ================================
   TABELA DE APOSTAS
================================ */
function renderBetsTable() {
  const tbody = document.querySelector("#betsTable tbody");
  tbody.innerHTML = "";

  bets.forEach((b,i) => {
    const cls = b.result === "Ganha"
      ? "status-ganha"
      : b.result === "Perdida"
        ? "status-perdida"
        : "status-pendente";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${b.id}</td>
      <td>${b.displayDatetime}</td>
      <td>${b.match}</td>
      <td>${b.market}</td>
      <td>${b.selection}</td>
      <td>${b.odd.toFixed(3)}</td>
      <td>${b.stake.toFixed(2)}</td>
      <td>${b.bankrollBefore.toFixed(2)}</td>
      <td>${b.bankrollAfter.toFixed(2)}</td>
      <td class="${cls}">${b.result}</td>
      <td>${b.profit.toFixed(2)}</td>
      <td>${b.martingaleStep}</td>
      <td>
        <button class="small" onclick="setBetResult(${i}, 'Ganha')">Ganha</button>
        <button class="small" onclick="setBetResult(${i}, 'Perdida')">Perdida</button>
        <button class="small" style="background:#b32424" onclick="deleteBet(${i})">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ==== FIM DA PARTE 2 ==== */
/* ================================
   ESTAT√çSTICAS + GR√ÅFICOS
================================ */
function computeAndUpdateStats() {
  const settled = bets.filter(b => b.result !== "Pendente");
  const totalStaked = settled.reduce((a,b)=>a+b.stake,0);
  const totalProfit = settled.reduce((a,b)=>a+b.profit,0);
  const wins   = settled.filter(b=>b.result==="Ganha").length;
  const losses = settled.filter(b=>b.result==="Perdida").length;
  const pending = bets.length - settled.length;

  statProfit.textContent   = totalProfit.toFixed(2) + " ‚Ç¨";
  statStaked.textContent   = totalStaked.toFixed(2) + " ‚Ç¨";
  statCounts.textContent   = `${wins}/${losses}/${pending}`;
  statROI.textContent      = ((totalProfit/totalStaked)*100 || 0).toFixed(2) + " %";
  statWinrate.textContent  = ((wins/settled.length)*100 || 0).toFixed(2) + " %";
  statBankroll.textContent = settings.bankroll.toFixed(2) + " ‚Ç¨";

  updateCharts(settled);
}

function updateCharts(settled) {
  const sorted = settled.slice().sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  const eqData = [];
  const eqLabels = [];

  let current = settings.initialBankroll || 0;
  eqData.push(current);
  eqLabels.push("Start");

  sorted.forEach(b => {
    eqLabels.push(new Date(b.datetime).toLocaleString());
    eqData.push(b.bankrollAfter);
  });

  if (equityChart) equityChart.destroy();
  equityChart = new Chart(document.getElementById("equityChart"), {
    type: "line",
    data: {
      labels: eqLabels,
      datasets: [{
        label: "Banca (‚Ç¨)",
        data: eqData,
        borderColor: "#2d7ef7",
        tension: 0.2
      }]
    }
  });

  const wins = settled.filter(b => b.result==="Ganha").length;
  const losses = settled.filter(b => b.result==="Perdida").length;
  const pending = bets.filter(b => b.result==="Pendente").length;

  if (resultPieChart) resultPieChart.destroy();
  resultPieChart = new Chart(document.getElementById("resultPieChart"), {
    type: "pie",
    data: {
      labels: ["Ganha", "Perdida", "Pendente"],
      datasets: [{
        data: [wins, losses, pending],
        backgroundColor: ["#2ecc71", "#e74c3c", "#f1c40f"]
      }]
    }
  });
}

/* ================================
   EXPORTA√á√ÉO CSV + LIMPAR BD
================================ */
function exportCSV() {
  let csv = "ID;Data;Jogo;Mercado;Sele√ß√£o;Odd;Stake;Antes;Depois;Resultado;Lucro;Passo\n";
  bets.forEach(b=>{
    csv += `${b.id};${b.displayDatetime};${b.match};${b.market};${b.selection};${b.odd};${b.stake};${b.bankrollBefore};${b.bankrollAfter};${b.result};${b.profit};${b.martingaleStep}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url  = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "apostas.csv";
  a.click();
}

async function clearAllBets() {
  if (!confirm("Tem certeza que deseja limpar todo o hist√≥rico?")) return;
  for (const b of bets) await deleteBetFromDB(b.id);
  bets = [];
  renderBetsTable();
  computeAndUpdateStats();
}

/* ================================
   JOGOS DO DIA ‚Äî API WORKER
================================ */
async function loadTodayMatches() {
  const sel = document.getElementById("todayMatchSelect");
  sel.innerHTML = "<option>A carregar...</option>";

  const date = new Date().toISOString().slice(0, 10);
  try {
    const res = await fetch(`${API_FOOTBALL_BASE_URL}/?date=${date}`);
    const data = await res.json();
    const fixtures = data.response || [];

    if (!fixtures.length) {
      sel.innerHTML = "<option>Sem jogos hoje</option>";
      return;
    }

    sel.innerHTML = "<option value=''>-- Escolhe um jogo --</option>";

    fixtures.forEach(game => {
      const time = new Date(game.fixture.date)
        .toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

      const value = `${game.teams.home.name} vs ${game.teams.away.name}`;
      const option = document.createElement("option");

      option.value = value;
      option.textContent = `${time} - ${value} (${game.league.name})`;

      sel.appendChild(option);
    });

  } catch (err) {
    console.error("Erro a carregar jogos:", err);
    sel.innerHTML = "<option>Erro ao carregar jogos</option>";
  }
}

/* ================================
   INICIALIZA√á√ÉO DO SISTEMA
================================ */
window.onload = async () => {
  await loadSettingsFromDB();
  await loadBetsFromDB();

  updateConfigUI();
  renderBetsTable();
  computeAndUpdateStats();

  loadTodayMatches();

  todayMatchSelect.addEventListener("change", () => {
    if (todayMatchSelect.value) {
      match.value = todayMatchSelect.value;
    }
  });
};
</script>

</body>
</html>
